<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Tap-Together | Heart Glow</title>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Inter:wght@400;600;700&display=swap');

    :root{
      --ink:#1b1b1f;
      --muted:rgba(27,27,31,.72);
      --paper:#fbf7ef;
      --paper2:#f6efe2;
      --gold:#c5a059;
      --gold2:#e3c27a;
      --rose:#d85a7a;
      --rose2:#ff8fb0;
      --good:#2f9d62;
      --warn:#b8872f;
      --bad:#c03b3b;

      --panel: rgba(255,255,255,.58);
      --panelBorder: rgba(27,27,31,.10);
      --shadow: 0 18px 60px rgba(0,0,0,.18);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--ink);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 700px at 20% 5%, rgba(197,160,89,.22), transparent 55%),
        radial-gradient(1000px 700px at 85% 70%, rgba(216,90,122,.14), transparent 60%),
        linear-gradient(180deg, var(--paper), var(--paper2));
      overflow:hidden;
    }

    .wrap{
      height:100%;
      display:grid;
      place-items:center;
      padding:18px;
    }

    .panel{
      width:min(760px, 96vw);
      background: var(--panel);
      border:1px solid var(--panelBorder);
      border-radius:24px;
      padding:18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      display:grid;
      gap:14px;
      position:relative;
      overflow:hidden;
    }

    /* subtle “aristocratic” ornament */
    .panel::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(600px 260px at 10% 0%, rgba(197,160,89,.16), transparent 60%),
        radial-gradient(600px 260px at 95% 100%, rgba(216,90,122,.10), transparent 60%);
      pointer-events:none;
    }

    .top{ position:relative; display:flex; gap:12px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; }
    h1{
      margin:0;
      font-family: "Playfair Display", serif;
      font-size:20px;
      letter-spacing:.2px;
      font-weight:700;
    }
    .sub{
      margin:6px 0 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
      max-width: 55ch;
    }

    .controls{ position:relative; display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .btn{
      appearance:none;
      border:1px solid rgba(27,27,31,.16);
      background: rgba(255,255,255,.55);
      color:var(--ink);
      padding:10px 12px;
      border-radius:14px;
      font-weight:700;
      font-size:13px;
      cursor:pointer;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.72); border-color: rgba(27,27,31,.22); }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn.primary{
      border-color: rgba(197,160,89,.55);
      background: linear-gradient(180deg, rgba(227,194,122,.45), rgba(197,160,89,.22));
    }

    .stage{
      position:relative;
      width:100%;
      aspect-ratio: 16 / 9;
      min-height: 360px;
      border-radius:22px;
      border:1px solid rgba(27,27,31,.12);
      background:
        radial-gradient(950px 520px at 50% 30%, rgba(216,90,122,.10), transparent 65%),
        radial-gradient(850px 520px at 40% 85%, rgba(197,160,89,.12), transparent 60%),
        rgba(255,255,255,.45);
      overflow:hidden;
      display:grid;
      place-items:center;
      padding:18px;
      touch-action: manipulation;
      position:relative;
    }

    .prompt{
      position:absolute;
      top:14px; left:14px; right:14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      pointer-events:none;
    }

    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(27,27,31,.12);
      background: rgba(255,255,255,.55);
      color: var(--muted);
      font-size:12px;
      pointer-events:none;
    }

    .stats{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .stat{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(27,27,31,.12);
      background: rgba(255,255,255,.55);
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
      pointer-events:none;
    }
    .stat b{ color: var(--ink); }

    .heartArea{
      position:relative;
      display:grid;
      place-items:center;
      width:min(320px, 56vw);
      aspect-ratio:1/1;
      user-select:none;
      -webkit-user-select:none;
    }

    .heart{
      font-size: clamp(92px, 14vw, 170px);
      transform: translateZ(0) scale(1);
      filter: drop-shadow(0 18px 35px rgba(216,90,122,.16));
      transition: transform 120ms ease;
      will-change: transform, filter;
    }

    .ring{
      position:absolute;
      width: 82%;
      height: 82%;
      border-radius: 999px;
      border: 2px solid rgba(216,90,122,.0);
      transform: scale(.65);
      opacity: 0;
      pointer-events:none;
    }

    .glowOn .heart{
      filter:
        drop-shadow(0 0 18px rgba(216,90,122,.55))
        drop-shadow(0 0 44px rgba(197,160,89,.28));
      animation: pulse 740ms ease-in-out both;
    }
    .glowOn .ring{ animation: ring 740ms ease-out both; }

    @keyframes pulse{
      0%{ transform: scale(1); }
      45%{ transform: scale(1.10); }
      100%{ transform: scale(1.02); }
    }
    @keyframes ring{
      0%{ opacity:0; transform: scale(.65); border-color: rgba(216,90,122,.0); }
      30%{ opacity:1; border-color: rgba(216,90,122,.42); }
      100%{ opacity:0; transform: scale(1.22); border-color: rgba(216,90,122,.0); }
    }

    .tapHint{
      position:absolute;
      bottom:14px;
      left:14px;
      right:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color: var(--muted);
      font-size:13px;
    }

    .bigTap{
      pointer-events:auto;
      border:none;
      background: rgba(255,255,255,.62);
      border:1px solid rgba(27,27,31,.14);
      color:var(--ink);
      padding:12px 14px;
      border-radius:16px;
      font-weight:800;
      cursor:pointer;
      display:inline-flex;
      gap:10px;
      align-items:center;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .bigTap:hover{ background: rgba(255,255,255,.78); border-color: rgba(27,27,31,.20); }
    .bigTap:active{ transform: translateY(1px) scale(.99); }

    .feedback{
      position:absolute;
      inset:auto 0 54px 0;
      display:grid;
      place-items:center;
      pointer-events:none;
      font-weight:900;
      letter-spacing:.3px;
      opacity:0;
      transform: translateY(8px);
      transition: opacity .18s ease, transform .18s ease;
      text-align:center;
      padding:0 14px;
    }
    .feedback.show{ opacity:1; transform: translateY(0); }
    .feedback small{
      display:block;
      font-weight:650;
      color: var(--muted);
      margin-top:6px;
      letter-spacing:0;
    }

    .meter{
      height:10px;
      border-radius:999px;
      background: rgba(27,27,31,.08);
      border:1px solid rgba(27,27,31,.10);
      overflow:hidden;
    }
    .meter > i{
      display:block;
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(192,59,59,.86), rgba(184,135,47,.90), rgba(47,157,98,.90));
      transition: width 180ms ease;
    }

    @media (max-width:520px){
      .stage{ min-height: 440px; aspect-ratio: 10/16; }
      .tapHint{ flex-direction:column; align-items:stretch; }
      .bigTap{ justify-content:center; width:100%; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="panel">
      <div class="top">
        <div>
          <h1>Tap-Together Challenge</h1>
          <p class="sub" id="subtitle">
            When the heart glows, everyone taps together. The closer your timing, the more dazzling the heart.
            A tiny ritual, a lovely little icebreaker.
          </p>
        </div>
        <div class="controls">
          <button class="btn" id="practiceBtn" title="Solo random glow timings">Practice</button>
          <button class="btn primary" id="roomBtn" title="Join room based on the page URL">Room Mode</button>
          <button class="btn" id="resetBtn" title="Reset score">Reset</button>
        </div>
      </div>

      <div class="stage" id="stage">
        <div class="prompt">
          <div class="pill" id="modePill">Mode: <b style="color:var(--ink)">Practice</b></div>
          <div class="stats">
            <div class="stat">Streak: <b id="streak">0</b></div>
            <div class="stat">Best: <b id="best">0</b>%</div>
            <div class="stat">Last: <b id="last">—</b></div>
          </div>
        </div>

        <div class="heartArea" id="heartArea">
          <div class="ring"></div>
          <div class="heart" id="heart" role="img" aria-label="Heart">❤️</div>
        </div>

        <div class="feedback" id="feedback">
          <div id="feedbackTitle">READY</div>
          <small id="feedbackSub">Wait for the glow…</small>
        </div>

        <div class="tapHint">
          <div style="flex:1; min-width:220px">
            <div style="display:flex; justify-content:space-between; gap:10px; margin-bottom:8px;">
              <span style="color:var(--muted); font-size:12px;">Harmony meter</span>
              <span style="color:var(--muted); font-size:12px;" id="windowLabel">±350ms window</span>
            </div>
            <div class="meter"><i id="meterFill"></i></div>
          </div>
          <button class="bigTap" id="tapBtn">Tap ❤️</button>
        </div>
      </div>

      <div class="pill" style="justify-content:space-between;">
        <span id="roomLabel">Room: <b style="color:var(--ink)" id="roomName">—</b></span>
        <span>Next glow in: <b style="color:var(--ink)" id="nextIn">—</b></span>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));

  // --- Deterministic RNG ---
  function mulberry32(seed) {
    let t = seed >>> 0;
    return function() {
      t += 0x6D2B79F5;
      let r = Math.imul(t ^ (t >>> 15), 1 | t);
      r ^= r + Math.imul(r ^ (r >>> 7), 61 | r);
      return ((r ^ (r >>> 14)) >>> 0) / 4294967296;
    };
  }

  // Simple string -> 32-bit hash (stable)
  function hash32(str){
    let h = 2166136261 >>> 0;
    for (let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }

  function fmtMs(ms){
    const sign = ms < 0 ? "−" : "+";
    const v = Math.abs(Math.round(ms));
    return `${sign}${v}ms`;
  }

  function haptic(pattern=[18]){
    if (navigator.vibrate) navigator.vibrate(pattern);
  }

  // --- Elements ---
  const stage = $("stage");
  const heart = $("heart");
  const meterFill = $("meterFill");
  const feedback = $("feedback");
  const feedbackTitle = $("feedbackTitle");
  const feedbackSub = $("feedbackSub");
  const streakEl = $("streak");
  const bestEl = $("best");
  const lastEl = $("last");
  const nextInEl = $("nextIn");
  const windowLabel = $("windowLabel");
  const modePill = $("modePill");
  const roomNameEl = $("roomName");
  const subtitle = $("subtitle");

  const practiceBtn = $("practiceBtn");
  const roomBtn = $("roomBtn");
  const resetBtn = $("resetBtn");
  const tapBtn = $("tapBtn");

  // --- Settings ---
  let WINDOW_MS = 350;
  windowLabel.textContent = `±${WINDOW_MS}ms window`;

  const PRACTICE_MIN = 1600;
  const PRACTICE_MAX = 3200;

  const ROOM_BEAT_MS = 2600;
  const ROOM_JITTER_MS = 650;

  // --- Room detection by URL ---
  // If URL has ?room=xxx => join that room (no extra “room link” UI)
  // Otherwise, practice mode by default.
  const params = new URLSearchParams(location.search);
  const roomId = (params.get("room") || "").trim(); // e.g. "isa"
  const hasRoom = !!roomId;

  // Seed from roomId + pathname + hostname (so different pages can host different rooms)
  const roomKey = hasRoom
    ? `${location.hostname}${location.pathname}::${roomId}`
    : "";

  const roomSeed = hasRoom ? hash32(roomKey) : null;

  // Start epoch: rounded to nearest 10 seconds so late-joiners still sync
  // (Everyone computes the same base from their local time, so we also quantize by minute boundary)
  // Better: define a constant start anchor derived from roomSeed (so truly stable).
  // We'll set an anchor date at Jan 1 2026 00:00 UTC plus roomSeed offset.
  const ANCHOR_UTC = Date.UTC(2026,0,1,0,0,0,0);
  const roomStartEpoch = hasRoom ? (ANCHOR_UTC + (roomSeed % (7*24*60*60*1000))) : null;

  let mode = hasRoom ? "room" : "practice";
  let rng = hasRoom ? mulberry32(roomSeed) : Math.random;

  // --- State ---
  let nextGlowAt = 0;
  let glowStartAt = 0;
  let acceptingTap = false;
  let lastTapAt = 0;

  let streak = 0;
  let best = 0;

  function setMode(nextMode){
    mode = nextMode;

    const label = mode === "room" ? "Room Mode" : "Practice";
    modePill.innerHTML = `Mode: <b style="color:var(--ink)">${label}</b>`;

    if (mode === "room") {
      subtitle.textContent =
        "When the heart glows, everyone taps together. Closer timing makes a more dazzling heart — a gentle little icebreaker.";
      roomNameEl.textContent = hasRoom ? roomId : "—";
      rng = hasRoom ? mulberry32(roomSeed) : mulberry32(123456789);
    } else {
      subtitle.textContent =
        "Practice your timing. When it glows, tap — and feel the rhythm before you try it with friends.";
      roomNameEl.textContent = "—";
      rng = Math.random;
    }

    resetRoundTimers();
    scheduleNextGlow();
  }

  function resetScore(){
    streak = 0; best = 0;
    streakEl.textContent = "0";
    bestEl.textContent = "0";
    lastEl.textContent = "—";
    meterFill.style.width = "0%";
    showFeedback("READY", "Wait for the glow…", null);
  }

  function resetRoundTimers(){
    acceptingTap = false;
    nextGlowAt = 0;
    glowStartAt = 0;
    stage.classList.remove("glowOn");
  }

  function scheduleNextGlow(){
    const nowPerf = performance.now();

    if (mode === "practice") {
      const delay = Math.floor(PRACTICE_MIN + (PRACTICE_MAX - PRACTICE_MIN) * Math.random());
      planGlow(nowPerf + delay);
    } else {
      // ROOM MODE — deterministic schedule based on the roomStartEpoch anchor.
      const nowEpoch = Date.now();

      const tSinceStart = nowEpoch - roomStartEpoch;
      const beatIndex = tSinceStart < 0 ? 0 : Math.floor(tSinceStart / ROOM_BEAT_MS) + 1;

      // deterministic jitter per beat (seed + beatIndex)
      const localRng = mulberry32((roomSeed ^ (beatIndex * 2654435761)) >>> 0);
      const jitter = (localRng() * 2 - 1) * ROOM_JITTER_MS;

      const nextBeatEpoch = roomStartEpoch + beatIndex * ROOM_BEAT_MS + jitter;

      // map epoch -> perf using offset
      const epochToPerfOffset = performance.now() - Date.now();
      planGlow(nextBeatEpoch + epochToPerfOffset);
    }
  }

  function planGlow(peakPerf){
    glowStartAt = peakPerf - 220;
    nextGlowAt = peakPerf;
    tickCountdown();

    const now = performance.now();
    const startDelay = Math.max(0, glowStartAt - now);
    const peakDelay  = Math.max(0, nextGlowAt - now);

    setTimeout(() => {
      stage.classList.add("glowOn");
      acceptingTap = true;
    }, startDelay);

    setTimeout(() => {
      showFeedback("TAP!", "Together, darling. Right on the glow ❤️", "accent");
      haptic([12]);

      setTimeout(() => stage.classList.remove("glowOn"), 760);

      setTimeout(() => {
        if (acceptingTap) {
          acceptingTap = false;
          streak = 0;
          streakEl.textContent = String(streak);
          lastEl.textContent = "Miss";
          meterFill.style.width = "0%";
          showFeedback("OOPS", "No worries — you’ll catch the next one.", "warn");
          haptic([25, 35, 25]);
        }
        scheduleNextGlow();
      }, WINDOW_MS + 40);

    }, peakDelay);
  }

  function tickCountdown(){
    const now = performance.now();
    const ms = nextGlowAt ? Math.max(0, nextGlowAt - now) : 0;
    nextInEl.textContent = nextGlowAt ? `${Math.ceil(ms/100)/10}s` : "—";
    if (nextGlowAt) requestAnimationFrame(tickCountdown);
  }

  function showFeedback(title, sub, tone){
    feedbackTitle.textContent = title;
    feedbackSub.textContent = sub;

    feedbackTitle.style.color =
      tone === "good" ? "var(--good)" :
      tone === "warn" ? "var(--warn)" :
      tone === "bad" ? "var(--bad)" :
      tone === "accent" ? "var(--rose)" :
      "var(--ink)";

    feedback.classList.add("show");
    clearTimeout(showFeedback._t);
    showFeedback._t = setTimeout(() => feedback.classList.remove("show"), 900);
  }

  function scoreTap(tapPerf){
    const delta = tapPerf - nextGlowAt;
    const absDelta = Math.abs(delta);

    const sync = clamp(1 - (absDelta / WINDOW_MS), 0, 1);
    const pct = Math.round(sync * 100);

    const scale = 1 + 0.38 * sync;
    heart.style.transform = `scale(${scale})`;
    setTimeout(() => heart.style.transform = "scale(1.02)", 120);

    meterFill.style.width = `${pct}%`;

    if (pct >= 60) streak++;
    else streak = 0;
    streakEl.textContent = String(streak);

    if (pct > best) best = pct;
    bestEl.textContent = String(best);
    lastEl.textContent = `${pct}%`;

    let title = "CLOSE";
    let sub = `Harmony: ${pct}% • Δ ${fmtMs(delta)}`;
    let tone = "warn";
    let vibe = [14];

    if (pct >= 95) { title = "DIVINE"; tone="good"; vibe=[18,25,18]; }
    else if (pct >= 85) { title = "GORGEOUS"; tone="good"; vibe=[18,18]; }
    else if (pct >= 70) { title = "LOVELY"; tone="accent"; vibe=[14,18]; }
    else if (pct >= 50) { title = "ALMOST"; tone="warn"; vibe=[12]; }
    else { title = "CHEEKY"; tone="bad"; vibe=[22]; }

    showFeedback(title, sub, tone);
    haptic(vibe);
  }

  function onTap(){
    const t = performance.now();
    if (t - lastTapAt < 120) return;
    lastTapAt = t;

    if (!nextGlowAt) return;

    const absDelta = Math.abs(t - nextGlowAt);
    if (absDelta <= WINDOW_MS) {
      acceptingTap = false;
      scoreTap(t);
      setTimeout(() => scheduleNextGlow(), 260);
    } else {
      showFeedback("STEADY", "Not yet — wait for the glow’s peak.", "warn");
      haptic([8]);
    }
  }

  stage.addEventListener("pointerdown", () => onTap(), {passive:true});
  tapBtn.addEventListener("click", onTap);

  window.addEventListener("keydown", (e) => {
    if (e.code === "Space" || e.key.toLowerCase() === "t") {
      e.preventDefault();
      onTap();
    }
  });

  practiceBtn.addEventListener("click", () => {
    // Remove room param (back to practice)
    const url = new URL(location.href);
    url.searchParams.delete("room");
    history.replaceState({}, "", url.toString());
    setMode("practice");
    showFeedback("PRACTICE", "Warm up your timing — then invite the room.", "accent");
  });

  roomBtn.addEventListener("click", () => {
    // If no room param, gently prompt once (still “just the URL”)
    if (!hasRoom) {
      const id = prompt("Pick a room name (e.g., isa, cf2026, hello):", "isa");
      if (!id) return;
      const url = new URL(location.href);
      url.searchParams.set("room", id.trim());
      location.href = url.toString();
      return;
    }
    setMode("room");
    showFeedback("ROOM MODE", "Everyone on this link will sync ❤️", "accent");
  });

  resetBtn.addEventListener("click", () => {
    resetScore();
    resetRoundTimers();
    scheduleNextGlow();
  });

  // iOS double-tap zoom guard
  let lastTouchEnd = 0;
  document.addEventListener("touchend", (e) => {
    const now = Date.now();
    if (now - lastTouchEnd <= 250) e.preventDefault();
    lastTouchEnd = now;
  }, { passive:false });

  // Init
  resetScore();
  if (hasRoom) {
    roomNameEl.textContent = roomId;
    setMode("room");
    showFeedback("WELCOME", "Open this same link on everyone’s phone.", "accent");
  } else {
    setMode("practice");
  }
})();
</script>
</body>
</html>
